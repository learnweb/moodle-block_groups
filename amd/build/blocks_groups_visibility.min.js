define(["jquery","core/ajax","core/url","core/notification","core/str"],function(a,b,c,d,e){var f=function(b){a(".block_groups").find(".warning"+b).remove()},g=function(b){var c=a(".block_groups");c.find(".spinner"+b).remove(),c.find(".imggroup-"+b).show()},h=function(){var b=a(".block_groups");b.find(".spinner-all").remove(),b.find(".imggroup").show()},i=function(){location.reload(!0)},j=function(){e.get_strings([{key:"errortitle",component:"block_groups"},{key:"nochangeindatabasepossiblereload",component:"block_groups"},{key:"yes"},{key:"no"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],i)}).fail(d.exception)},k=function(b){var d=a(".block_groups");d.find(".warning"+b).length>0&&f(b);var e=c.imageUrl("i/loading_small","moodle"),g=document.createElement("img");g.className="spinner"+b+" spinner block-groups-spinner",g.src=e,g.hidden=!1,d.find(".imggroup-"+b).before(g),d.find(".imggroup-"+b).hide()},l=function(b){var d=a(".block_groups"),e=d.find(".warning"+b);if(e.length)return g(b),!1;"all"===b?h():g(b);var f=c.imageUrl("i/warning","moodle"),i=document.createElement("img");return i.className="warning"+b+" block-groups-warning",i.src=f,j(),d.find(".imggroup-"+b).before(i),d.find(".imggroup-"+b).on("click",j),d.find(".warning"+b).on("click",j),!1},m=function(c){var d=a(".block_groups"),e=a(this).data("groupid");if(d.find(".spinner"+a(this).data("groupid")).length>0||d.find(".spinner-all").length>0)return!1;k(a(this).data("groupid"));var f=b.call([{methodname:"block_groups_create_output",args:{groups:{id:a(this).data("groupid"),courseid:c.data.courseid}}}]);return a(document).ajaxError(function(){return l(e),!1}),f[0].then(function(a){return null===a||a.error===!0?(l(e),!1):(d.find(".group-"+a.id).replaceWith(a.newelement),0===a.visibility&&d.find(".membergroup-"+a.id).removeClass("hiddengroups"),1===a.visibility&&d.find(".membergroup-"+a.id).addClass("hiddengroups"),d.find(".group-"+a.id+" .block_groups_toggle").on("click",{courseid:c.data.courseid},m),g(a.id),!1)}).fail(function(){return l(e),!1}),!1},n=function(b){var c=a(".block-groups-membergroup"),d=b.visibility;2===d&&c.removeClass("hiddengroups"),1===d&&c.addClass("hiddengroups")},o=function(){var b=a(".block_groups");b.find(".warningall").length>0&&f("all");var d=c.imageUrl("i/loading_small","moodle"),e=document.createElement("img");e.className="spinner-all spinner block-groups-spinner",e.src=d,e.hidden=!1,b.find(".imggroup").before(e),b.find(".imggroup").hide()},p=function(a,b){d.addNotification({message:b,type:a})},q=function(c){if(a(".block_groups").find(".spinner").length>0)return!1;var f=a(".block_groups").find(".block-groups-warning");if("undefined"!=typeof f&&f.length>0)return l("all"),!1;o();var g=b.call([{methodname:"block_groups_create_allgroups_output",args:{groups:{action:a(this).data("action"),courseid:c.data.courseid}}}]);return a(document).ajaxError(function(){return l("all"),!1}),g[0].then(function(b){var f=a(".block_groups");return null===b||b.error===!0?(l("all"),!1):0===b.visibility?(f.find(".content").replaceWith(b.newelement),e.get_strings([{key:"nogroups",component:"block_groups"}]).done(function(a){p("error",a[0])}).fail(d.exception),!1):(f.find(".wrapperlistgroup").replaceWith(b.newelement),f.find(".block_groups_toggle").on("click",{courseid:c.data.courseid},m),n(b),e.get_strings([{key:"groupschangedhidden",component:"block_groups"},{key:"groupschangedvisible",component:"block_groups"},{key:"allgroupsinstatehidden",component:"block_groups"},{key:"allgroupsinstatevisible",component:"block_groups"}]).done(function(a){switch(b.visibility){case 1:p("success",a[0]);break;case 2:p("success",a[1]);break;case 3:p("warning",a[2]);break;case 4:p("warning",a[3])}}).fail(d.exception),!1)}).fail(function(){return l("all"),!1}),h(),!1};return{initialise:function(b){a(".block_groups_toggle").on("click",{courseid:b},m),a(".block_groups_all_toggle").on("click",{courseid:b},q)}}});